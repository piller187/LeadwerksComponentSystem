<!DOCTYPE html>
<html>
  <head>
    <title>Hello World!</title>
	<style type="text/css" media="screen">
		html, body {
			width: 100%;
			height: 100%;
			margin: 0;
		}
		
		#layout {
			width: 100%;
			height: 100%;
		}
		
		.editor {
            height: 100%;
			width: 100%;
            display: block;
            position:relative;
	    }
		
body .ace_scrollbar-v {
    overflow-y: auto;
}

body .ace_scrollbar-h {
    overflow-x: auto;
}
	</style>
	<link rel="stylesheet" type="text/css" href="libs/w2ui/w2ui-1.5.rc1.min.css" />
	<link rel="stylesheet" type="text/css" href="libs/jquery-ui/jquery-ui.min.css" />
	<link rel="stylesheet" type="text/css" href="libs/jquery-ui/jquery-ui.theme.min.css" />
	
	<script src="libs/jquery/jquery-3.2.1.min.js"></script>
	<script src="libs/jquery-ui/jquery-ui.min.js"></script>
	
	<script src="libs/ace/ace.js"></script>
	<script src="libs/w2ui/w2ui-1.5.rc1.min.js"></script>
	<script src="libs/thenby/thenBy.min.js"></script>
  </head>
  <body>
	<input id="fileDialog" type="file" accept=".werk" style="display: none;">
	
	<div id="layout"></div>
	
	<script>
		var fs = require("fs");
		var tabs = $("#fileTabs").tabs();
		var editors = {};
		
		$(document).tooltip({
			position: {
				my: "center bottom-10",
				at: "center top"
			}
		});
		
		$.fn.addEditorTab = function(name, tabName, contents) {
			console.log("1");
			$('ul', this).append('<li title="' + name + '"><a href="#tab-' + name + '">' + tabName + '</a><span class="ui-icon ui-icon-close" role="presentation"></li>');
			$(this).append("<div id='tab-" + name + "'><div id='editor-" + name + "' class='editor'></div></div>");
			$(this).tabs("refresh");
			console.log("2");
			
			var editor = ace.edit("editor-" + name);
			console.log("3");
			editor.setTheme("ace/theme/monokai");
			editor.getSession().setMode("ace/mode/lua");
			editor.setOptions({
				maxLines: Infinity
			});
			editor.getSession().setValue(contents);
			
			return editor;
		};
		
		// main starting point
		$(function(){
			// close tabs
			tabs.on("click", "span.ui-icon-close", function() {
				var panelId = $(this).closest("li").remove().attr("aria-controls");
				var editorId = panelId.replace("tab-", "editor-");

				$("div[id='" + editorId + "']").remove();
				$("div[id='" + panelId + "']").remove();
				editors[editorId.replace("editor-", "")].destroy();

				tabs.tabs("refresh");
			});
			
			//tabs.addEditorTab("test", "test", "test");
		
			setupMenu();
			
			var pstyle = 'border: 1px solid #dfdfdf; padding: 5px;';
			$('#layout').w2layout({
				name: 'layout',
				panels: [
					{ type: 'top', size: 50, style: pstyle, content: 'top', resizable: true },
					{ type: 'left', size: 300, style: pstyle, content: '<div id="sidebar" style="height: 100%; width: 100%;"></div>', resizable: true },
					//{ type: 'main', style: pstyle, content: '<div id="editor"></div>' }
					{ type: 'main', style: pstyle, content: '<div id="fileTabs"><ul></ul></div>' }
				]
			});
	
			//var editor = ace.edit("editor");
			//editor.setTheme("ace/theme/monokai")
			//editor.getSession().setMode("ace/mode/lua")
			//editor.renderer.setShowPrintMargin(false);
			
			// setting up the folder structure of the sidebar
			$("#fileDialog").change(function(e){			
				var path = e.target.files[0].path.replace(e.target.files[0].name, "");
				
				var obj = {
					id: path.replace(/\\/g, "/"),
					text: e.target.files[0].name.replace(".werk", ""),
					img: 'icon-folder',
					expanded: true,
					nodes: []
				};
				
				setupFileTree(obj.nodes, path);
				//console.log(obj);
				
				w2ui.sidebar.add(obj);
			});
			
			// opening a file from the sidebar
			$('#sidebar').w2sidebar({
				name : 'sidebar',
				img  : 'icon-page',
				onDblClick: function(event){
					var stats = fs.statSync(event.target);
					
					if(stats.isFile() && event.target.indexOf(".lua") != -1){
						var fileContents = fs.readFileSync(event.target, "utf8");
						var fileName = event.target.split('/').pop();
						console.log(fileContents);
						console.log(fileName);

						editors[event.target] = tabs.addEditorTab(event.target, fileName, fileContents);
					}
				}
			});
		});
		
		function setupFileTree(node, path){
			var files = fs.readdirSync(path);
			
			for(var i = 0; i < files.length; i++){
				var file = path + files[i];
				var stats = fs.statSync(file);
				
				// adding directories
				if(stats.isDirectory()){
					file += "/";
					
					var obj = {
						id: file.replace(/\\/g, "/"),
						text: files[i],
						img: 'icon-folder',
						nodes: []
					};
					
					node.push(obj);
					
					// recursive into this folder
					setupFileTree(obj.nodes, file);
					
					// this makes it so folders are listed first in alphabetical order then files are listed next in alphabetical order
					obj.nodes.sort(
						firstBy(function(v) { return v.img })
						.thenBy("text")
					);
					
					var nodes = obj.nodes.filter(function(el){
						return el.text.indexOf(".lua") != -1;
					});
					
					//obj.nodes = nodes;
				}
				
				// adding files
				if(stats.isFile()){
					 if(file.indexOf(".lua") != -1){
						var obj = {
							id: file.replace(/\\/g, "/"),
							text: files[i],
							img: 'icon-page'
						};
					
						node.push(obj);
					}
				}
			}
		}
			
		function setupMenu(){
			var menubar = new nw.Menu({
				type: 'menubar'
			});

			var fileMenu = new nw.Menu();

			fileMenu.append(new nw.MenuItem({
				label: 'Open Project',
				click: function() {
					$("#fileDialog").trigger("click");
				}
			}));

			/*
			var openRecentMenu = new nw.Menu();

			openRecentMenu.append(new nw.MenuItem({
				label: 'Recente File X',
				click: function() {
					alert('Clicked to open a recent file');
				}
			}));
			*/

			menubar.append(new nw.MenuItem({ label: 'File', submenu: fileMenu}));
			//fileMenu.append(new nw.MenuItem({ label: 'Open Recent File', submenu: openRecentMenu}));

			var win = nw.Window.get();
			win.menu = menubar;
		}
	</script>
  </body>
</html>
